files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_start_app.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      cd /var/app/current
      
      # Install dependencies
      if [ ! -d "node_modules" ]; then
        npm install
      fi

      # Check if the application is already running
      if ! pgrep -f "node dist/index.js" > /dev/null; then
        # Start the application
        npm start > /var/log/nodejs_app.log 2>&1 &
        echo "Node.js application started"
      else
        echo "Node.js application is already running"
      fi

container_commands:
  01_ensure_port_config:
    command: |
      # Make sure the app listens on the port Nginx expects (8080)
      if [ -f ".env" ]; then
        grep -q "PORT=8080" .env || echo "PORT=8080" >> .env
      else
        echo "PORT=8080" > .env
      fi 