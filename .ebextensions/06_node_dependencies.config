commands:
  01_install_dependencies:
    command: |
      #!/bin/bash
      echo "===== NODE ENVIRONMENT ====="
      node -v
      npm -v
      
      echo "===== INSTALL CORS DIRECTLY ====="
      cd /var/app/staging
      mkdir -p node_modules/cors
      
      # Create a basic package.json for cors if it doesn't exist
      if [ ! -d "/var/app/staging/node_modules/cors" ]; then
        mkdir -p /var/app/staging/node_modules/cors
        cat > /var/app/staging/node_modules/cors/package.json << 'EOF'
{"name":"cors","version":"2.8.5","description":"Node.js CORS middleware","main":"lib/index.js","dependencies":{"object-assign":"^4","vary":"^1"}}
EOF
      fi
      
      # Get necessary cors module files from npm CDN
      curl -s https://unpkg.com/cors@2.8.5/lib/index.js -o /var/app/staging/node_modules/cors/index.js
      curl -s https://unpkg.com/cors@2.8.5/package.json -o /var/app/staging/node_modules/cors/package.json
      
      # Create basic implementation of object-assign
      mkdir -p /var/app/staging/node_modules/object-assign
      cat > /var/app/staging/node_modules/object-assign/index.js << 'EOF'
'use strict';module.exports=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};
EOF
      
      # Create basic implementation of vary
      mkdir -p /var/app/staging/node_modules/vary
      cat > /var/app/staging/node_modules/vary/index.js << 'EOF'
'use strict';module.exports=function vary(res,field){if(!res||!field)return;var val=res.getHeader?res.getHeader('Vary'):'';var header=Array.isArray(val)?val.join(', '):String(val);if((val=append(header,field))){res.setHeader&&res.setHeader('Vary',val);}return res;};function append(header,field){if(typeof header!=='string')return field;var fields=header.split(',');var added=false;field.split(',').forEach(function(f){f=f.trim();if(fields.indexOf(f)===-1){fields.push(f);added=true;}});return added?fields.join(', '):header;}
EOF
      
      # Set permissions
      chmod -R 755 /var/app/staging/node_modules
      
      echo "===== VERIFYING CORS INSTALLATION ====="
      ls -la /var/app/staging/node_modules/cors
      
      echo "Cors module installed manually"
    ignoreErrors: true 