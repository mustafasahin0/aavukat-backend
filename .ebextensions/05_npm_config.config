files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/45npm.sh":
    mode: "000755"
    owner: webapp
    group: webapp
    content: |
      #!/bin/bash
      
      # Install dependencies in the source directory
      cd /var/app/staging
      
      # Output some debug info
      echo "Node version:"
      node -v
      echo "NPM version:"
      npm -v
      
      # Clean any problematic local installs
      echo "Cleaning existing installations..."
      rm -rf node_modules
      rm -f package-lock.json
      
      # Install dependencies directly with npm
      echo "Installing dependencies with npm..."
      npm install --legacy-peer-deps
      
      # Force install critical modules that seem to be missing
      echo "Force installing critical modules..."
      npm install cors express dotenv body-parser jsonwebtoken --save
      
      # Check if cors is installed
      if [ -d "node_modules/cors" ]; then
        echo "CORS module was installed successfully"
      else
        echo "ERROR: CORS module installation failed!"
      fi
      
      # Ensure correct permissions
      chown -R webapp:webapp /var/app/staging/node_modules 