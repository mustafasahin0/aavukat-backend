files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/45npm_install.sh":
    mode: "000755"
    owner: webapp
    group: webapp
    content: |
      #!/bin/bash
      
      # Set working directory
      cd /var/app/staging
      
      # Output debug info
      echo "Node version: $(node -v)"
      echo "NPM version: $(npm -v)"
      
      # Clean any problematic local installs
      echo "Cleaning existing installations..."
      rm -rf node_modules
      rm -f package-lock.json
      
      # Install dependencies with npm
      echo "Installing dependencies with npm..."
      npm install --production
      
      # Force install critical modules
      echo "Force installing critical modules..."
      npm install cors express dotenv body-parser jsonwebtoken
      
      # Verify installation of critical modules
      if [ -d "node_modules/cors" ]; then
        echo "CORS module was installed successfully"
      else
        echo "ERROR: CORS module installation failed! Trying alternative installation..."
        npm install cors --save
      fi
      
      # Check again and try global install as last resort
      if [ ! -d "node_modules/cors" ]; then
        echo "Installing cors globally and creating a local link..."
        npm install -g cors
        npm link cors
      fi
      
      # Ensure correct permissions
      chown -R webapp:webapp node_modules 