files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/45pnpm.sh":
    mode: "000755"
    owner: webapp
    group: webapp
    content: |
      #!/bin/bash
      
      # Install dependencies in the source directory
      cd /var/app/staging
      
      # Output some debug info
      echo "Node version:"
      node -v
      echo "NPM version:"
      npm -v
      
      # Check if pnpm is installed
      if ! command -v pnpm &> /dev/null; then
        echo "Installing pnpm..."
        npm install -g pnpm
      fi
      
      echo "PNPM version:"
      pnpm --version
      
      # Clean any problematic local installs
      echo "Cleaning existing installations..."
      rm -rf node_modules
      rm -f package-lock.json
      rm -f pnpm-lock.yaml
      
      # Install dependencies with pnpm
      echo "Installing dependencies with pnpm..."
      pnpm install --no-frozen-lockfile
      
      # Force install critical modules if they're missing
      if [ ! -d "node_modules/cors" ] || [ ! -d "node_modules/express" ]; then
        echo "Force installing critical modules..."
        pnpm add cors express dotenv body-parser jsonwebtoken
      fi
      
      # Check if cors is installed
      if [ -d "node_modules/cors" ]; then
        echo "CORS module was installed successfully"
      else
        echo "ERROR: CORS module installation failed!"
      fi
      
      # Ensure correct permissions
      chown -R webapp:webapp /var/app/staging/node_modules 