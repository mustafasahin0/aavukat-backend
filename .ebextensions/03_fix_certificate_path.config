files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/01_fix_certificate_permissions.sh":
    mode: "000755"
    owner: webapp
    group: webapp
    content: |
      #!/bin/bash
      
      # Create a script to run after application deployment to ensure certificate is properly set up
      echo "Running certificate fix script..."
      
      # Ensure certificate directory exists
      mkdir -p /var/app/current/dist
      
      # Check if certificate exists in the app directory
      if [ -f /var/app/current/global-bundle.pem ]; then
        echo "Certificate found in application directory."
        
        # Copy to other locations for redundancy
        cp /var/app/current/global-bundle.pem /var/app/current/dist/global-bundle.pem
        cp /var/app/current/global-bundle.pem /etc/ssl/certs/global-bundle.pem
      else
        # Download certificate if it doesn't exist
        echo "Certificate not found. Downloading..."
        wget -O /var/app/current/global-bundle.pem https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem
        
        # Copy to other locations
        cp /var/app/current/global-bundle.pem /var/app/current/dist/global-bundle.pem
        cp /var/app/current/global-bundle.pem /etc/ssl/certs/global-bundle.pem
      fi
      
      # Set proper permissions
      chmod 644 /var/app/current/global-bundle.pem
      chmod 644 /var/app/current/dist/global-bundle.pem
      chmod 644 /etc/ssl/certs/global-bundle.pem
      
      # Change ownership
      chown webapp:webapp /var/app/current/global-bundle.pem
      chown webapp:webapp /var/app/current/dist/global-bundle.pem
      
      echo "Certificate setup completed."
      
      # Restart application to pick up certificate changes
      echo "Restarting application..."
      systemctl restart web
      
      echo "Certificate fix completed!" 