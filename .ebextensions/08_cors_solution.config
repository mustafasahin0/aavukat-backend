files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/02_cors_direct_fix.sh":
    mode: "000755"
    owner: webapp
    group: webapp
    content: |
      #!/bin/bash
      
      echo "===== CORS DIRECT FIX SCRIPT ====="
      
      # Install cors globally to make it available
      npm install -g cors
      
      # Create a symbolic link for global node modules
      mkdir -p /var/app/staging/node_modules
      
      # Create links from global modules to app directory
      for MODULE in cors vary object-assign; do
        if [ -d "/usr/local/lib/node_modules/$MODULE" ]; then
          echo "Linking global $MODULE to local node_modules"
          ln -sf /usr/local/lib/node_modules/$MODULE /var/app/staging/node_modules/$MODULE
        fi
      done
      
      # Prepare backup cors implementation
      mkdir -p /var/app/staging/node_modules/cors
      
      # Create direct implementation of CORS
      cat > /var/app/staging/node_modules/cors/index.js << 'EOF'
'use strict';var vary=function(res,field){if(!res||!field)return res;var val=res.getHeader?res.getHeader('Vary'):'';var header=val?val+', '+field:field;res.setHeader&&res.setHeader('Vary',header);return res;};var defaults={origin:'*',methods:'GET,HEAD,PUT,PATCH,POST,DELETE',preflightContinue:false,optionsSuccessStatus:204};function configureOrigin(options,req){var requestOrigin=req.headers.origin;var headers=[];var isAllowed;if(!options.origin||options.origin==='*'){headers.push({key:'Access-Control-Allow-Origin',value:'*'});}else if(typeof options.origin==='string'){headers.push({key:'Access-Control-Allow-Origin',value:options.origin});headers.push({key:'Vary',value:'Origin'});}else{isAllowed=options.origin===requestOrigin;headers.push({key:'Access-Control-Allow-Origin',value:isAllowed?requestOrigin:false});headers.push({key:'Vary',value:'Origin'});}return headers;}function configureMethods(options){var methods=options.methods||defaults.methods;return{key:'Access-Control-Allow-Methods',value:methods};}function configureCredentials(options){if(options.credentials===true){return{key:'Access-Control-Allow-Credentials',value:'true'};}return null;}function configureAllowedHeaders(options,req){var allowedHeaders=options.allowedHeaders;var headers=[];if(!allowedHeaders){allowedHeaders=req.headers['access-control-request-headers'];headers.push({key:'Vary',value:'Access-Control-Request-Headers'});}if(allowedHeaders){headers.push({key:'Access-Control-Allow-Headers',value:allowedHeaders});}return headers;}function configureMaxAge(options){if(typeof options.maxAge==='number'){return{key:'Access-Control-Max-Age',value:options.maxAge.toString()};}return null;}function corsMiddleware(options){options=options||{};for(var key in defaults){if(!options[key]){options[key]=defaults[key];}}return function corsHandler(req,res,next){var headers=[];var method=req.method&&req.method.toUpperCase&&req.method.toUpperCase();if(method==='OPTIONS'){headers=headers.concat(configureOrigin(options,req));headers.push(configureMethods(options));var credentialsHeader=configureCredentials(options);if(credentialsHeader){headers.push(credentialsHeader);}headers=headers.concat(configureAllowedHeaders(options,req));var maxAgeHeader=configureMaxAge(options);if(maxAgeHeader){headers.push(maxAgeHeader);}headers.forEach(function(header){if(header&&header.key&&header.value){res.setHeader(header.key,header.value);}});if(options.preflightContinue){next();}else{res.statusCode=options.optionsSuccessStatus;res.setHeader('Content-Length','0');res.end();}}else{headers=headers.concat(configureOrigin(options,req));var credentialsHeader=configureCredentials(options);if(credentialsHeader){headers.push(credentialsHeader);}headers.forEach(function(header){if(header&&header.key&&header.value){res.setHeader(header.key,header.value);}});next();}};}module.exports=corsMiddleware;module.exports.defaults=defaults;
EOF
      
      # Create package.json for cors
      cat > /var/app/staging/node_modules/cors/package.json << 'EOF'
{"name":"cors","version":"2.8.5","description":"Node.js CORS middleware (direct implementation)","main":"index.js"}
EOF
      
      # Set permissions
      chmod -R 755 /var/app/staging/node_modules
      
      echo "CORS direct fix completed" 