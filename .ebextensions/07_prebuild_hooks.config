files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_ensure_modules.sh":
    mode: "000755"
    owner: webapp
    group: webapp
    content: |
      #!/bin/bash
      set -e
      
      echo "========== PRE-DEPLOYMENT MODULE CHECK =========="
      
      # Create .npmrc to improve npm performance
      cat > /var/app/staging/.npmrc << 'EOF'
      registry=https://registry.npmjs.org/
      fund=false
      audit=false
      progress=false
      loglevel=error
      save-exact=true
      ignore-scripts=false
      package-lock=false
      engine-strict=false
      EOF
      
      cd /var/app/staging
      
      # Check if package.json exists
      if [ ! -f "package.json" ]; then
        echo "ERROR: package.json not found in staging directory!"
        exit 1
      fi
      
      echo "Contents of package.json:"
      cat package.json
      
      # Ensure critical dependencies are in package.json
      if ! grep -q '"cors"' package.json; then
        echo "Adding cors to package.json dependencies..."
        node -e "const fs=require('fs'); const pkg=JSON.parse(fs.readFileSync('package.json')); pkg.dependencies=pkg.dependencies||{}; pkg.dependencies.cors='^2.8.5'; fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));"
      fi
      
      echo "Updated package.json:"
      cat package.json
      
      echo "Prebuild module check complete." 